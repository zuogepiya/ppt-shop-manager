# 常见问题解决方案 - Vercel + Supabase 部署

本文档汇总了部署和使用过程中可能遇到的常见问题及其解决方案。

---

## 目录

1. [Supabase相关问题](#supabase相关问题)
2. [Vercel相关问题](#vercel相关问题)
3. [数据库连接问题](#数据库连接问题)
4. [功能使用问题](#功能使用问题)
5. [性能优化问题](#性能优化问题)
6. [安全问题](#安全问题)

---

## Supabase相关问题

### 1.1 Supabase项目创建失败

**症状**：创建项目时显示错误或长时间卡住

**可能原因**：
- 网络连接问题
- Supabase服务器繁忙
- 密码不符合要求

**解决方案**：
1. 检查网络连接是否正常
2. 刷新页面重试
3. 确保密码至少8位，包含字母和数字
4. 如果超过10分钟未完成，建议更换浏览器或稍后重试

---

### 1.2 获取不到连接字符串

**症状**：在Supabase设置中找不到Connection String

**解决方案**：
1. 登录Supabase Dashboard
2. 点击左侧菜单的 **Settings** 图标
3. 选择 **Database**
4. 向下滚动到 **Connection string** 部分
5. 选择 **URI** 标签
6. 点击 **Copy** 按钮

**注意**：
- 如果项目刚创建，可能需要等待1-2分钟
- 确认选择的是 "URI" 而非 "Transaction pooling"

---

### 1.3 数据库密码忘记

**症状**：忘记了Supabase数据库密码

**解决方案**：
1. 登录Supabase Dashboard
2. 进入项目设置
3. 找到 **Database** > **Reset Database Password**
4. 重置密码
5. **重要**：重置后需要更新Vercel中的 `DATABASE_URL` 环境变量

---

### 1.4 Supabase存储空间不足

**症状**：提示存储空间已满

**解决方案**：
1. 进入Supabase Dashboard
2. 查看 **Storage** 标签
3. 删除不需要的文件
4. 如果确实需要更多空间，考虑升级套餐

**预防措施**：
- 定期清理测试数据
- 使用压缩格式存储大文件
- 监控存储使用量

---

## Vercel相关问题

### 2.1 Vercel部署失败

**症状**：部署时显示错误

**常见错误**：

#### 错误1: Build Failed

**可能原因**：
- 代码有语法错误
- 依赖包版本冲突
- 环境变量未设置

**解决方案**：
1. 在本地执行 `pnpm build` 测试
2. 检查构建日志中的具体错误信息
3. 确认所有环境变量已配置
4. 检查 `package.json` 中的依赖版本

#### 错误2: Module not found

**可能原因**：
- 缺少依赖包
- 文件路径错误
- 导入语句错误

**解决方案**：
```bash
# 重新安装依赖
pnpm install

# 检查导入路径
# 确保使用相对路径 @/ 开头的别名
```

#### 错误3: DATABASE_URL is not defined

**可能原因**：
- 环境变量未配置
- 环境变量名称错误

**解决方案**：
1. 进入Vercel项目设置
2. 点击 **Environment Variables**
3. 添加 `DATABASE_URL`（注意大小写）
4. 重新部署项目

---

### 2.2 Vercel部署很慢

**症状**：部署时间超过5分钟

**可能原因**：
- 首次部署，需要下载依赖
- 项目体积过大
- Vercel服务器繁忙

**解决方案**：
1. 首次部署较慢是正常的
2. 检查 `next.config.ts` 配置是否合理
3. 优化 `.vercelignore` 文件，排除不必要的文件
4. 如果经常超时，考虑优化项目结构

**优化建议**：
```javascript
// next.config.ts
const config = {
  // 排除不必要的文件
  excludeDefaultMomentLocales: true,
  // 优化图片
  images: {
    formats: ['image/avif', 'image/webp'],
  },
};
```

---

### 2.3 自定义域名配置失败

**症状**：域名显示 Pending 或 Error

**解决方案**：
1. 确认域名已正确解析到Vercel
2. 检查DNS配置（A记录或CNAME）
3. 等待DNS生效（通常需要5-30分钟）
4. 使用在线工具检查DNS：https://dnschecker.org

**DNS配置示例**：
```
类型: CNAME
主机记录: @ (或 www)
记录值: cname.vercel-dns.com
```

---

## 数据库连接问题

### 3.1 数据库连接失败

**症状**：应用提示"数据库连接失败"

**可能原因**：
- DATABASE_URL配置错误
- Supabase项目暂停
- 密码错误
- 网络问题

**解决方案**：

**步骤1：检查DATABASE_URL**
```bash
# 格式应该如下
postgresql://postgres.abc123:password@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres
```

**步骤2：验证连接**
1. 在Supabase Dashboard中，打开SQL Editor
2. 执行简单查询：`SELECT NOW();`
3. 如果能执行，说明数据库正常

**步骤3：检查项目状态**
1. 登录Supabase
2. 确认项目状态为 "Active"
3. 如果是 "Paused"，点击恢复

**步骤4：更新环境变量**
1. 进入Vercel项目设置
2. 更新 `DATABASE_URL`
3. 重新部署项目

---

### 3.2 数据库表不存在

**症状**：提示 "relation does not exist"

**可能原因**：
- 未执行数据库初始化
- 数据库被重置
- 表名拼写错误

**解决方案**：
1. 访问 `https://your-app.vercel.app/api/db-init`
2. 确认返回成功消息
3. 如果失败，检查Supabase日志

**手动创建表（备用方案）**：
```sql
-- 在Supabase SQL Editor中执行
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- 其他表同理...
```

---

### 3.3 数据插入失败

**症状**：提示测试数据插入失败

**可能原因**：
- 表结构未创建
- 外键约束错误
- 数据格式错误

**解决方案**：
1. 确保已执行 `/api/db-init`
2. 检查Supabase日志查看具体错误
3. 在SQL Editor中手动插入测试数据

---

## 功能使用问题

### 4.1 登录失败

**症状**：输入正确账号密码仍无法登录

**可能原因**：
- 数据库未初始化
- 测试数据未插入
- Session过期
- Cookie被阻止

**解决方案**：

**检查1：数据库初始化**
```bash
# 访问初始化API
curl https://your-app.vercel.app/api/db-init
curl https://your-app.vercel.app/api/test-data
```

**检查2：浏览器设置**
1. 打开浏览器开发者工具 (F12)
2. 查看 Console 是否有错误
3. 查看 Application > Cookies，确认Cookie存在
4. 检查是否阻止了第三方Cookie

**检查3：清除缓存**
1. 清除浏览器缓存和Cookie
2. 使用无痕模式测试
3. 尝试其他浏览器

---

### 4.2 权限错误

**症状**：显示"无权访问此功能"

**可能原因**：
- 角色权限配置错误
- Session丢失
- 账号被禁用

**解决方案**：
1. 确认使用的是正确的测试账号
2. 检查用户表中的 `role` 和 `is_active` 字段
3. 重新登录刷新Session
4. 在数据库中直接查询用户权限

```sql
-- 查看用户权限
SELECT username, role, is_active FROM users;
```

---

### 4.3 页面404

**症状**：访问某些页面显示404

**可能原因**：
- 路由配置错误
- 文件路径错误
- 部署不完整

**解决方案**：
1. 确认页面路由路径正确
2. 检查 `src/app` 目录结构
3. 在Vercel部署日志中查看构建输出
4. 重新部署项目

---

### 4.4 API返回500错误

**症状**：调用API时返回500 Internal Server Error

**解决方案**：
1. 检查Vercel Function Logs
2. 查看Supabase Logs
3. 在浏览器控制台查看详细错误信息
4. 检查API路由代码逻辑

---

## 性能优化问题

### 5.1 页面加载慢

**症状**：首次加载超过3秒

**解决方案**：

**1. 启用图片优化**
```javascript
// next.config.ts
images: {
  formats: ['image/avif', 'image/webp'],
  deviceSizes: [640, 750, 828, 1080, 1200],
  imageSizes: [16, 32, 48, 64, 96],
}
```

**2. 启用静态生成**
```typescript
// 对于不常变化的页面使用静态生成
export const dynamic = 'force-static';
```

**3. 优化依赖包**
```bash
# 分析包大小
pnpm build --analyze

# 移除未使用的包
pnpm remove unused-package
```

---

### 5.2 API响应慢

**症状**：API请求需要很长时间

**解决方案**：

**1. 数据库查询优化**
```sql
-- 添加索引
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_users_role ON users(role);
```

**2. 启用缓存**
```typescript
// 使用Vercel KV或Redis
// 缓存频繁访问的数据
```

**3. 使用连接池**
```typescript
// 已在 dbAdapter.ts 中配置
max: 10, // 增加连接池大小
```

---

## 安全问题

### 6.1 默认密码未修改

**风险**：测试账号密码公开，存在安全隐患

**解决方案**：
1. 登录系统后立即修改所有默认密码
2. 使用强密码（至少12位，包含大小写字母、数字、符号）
3. 定期更换密码

**修改方法**：
1. 使用admin账号登录
2. 进入"用户管理"
3. 为每个用户重置密码
4. 通知用户新密码

---

### 6.2 HTTPS证书问题

**症状**：浏览器提示"不安全"或证书错误

**解决方案**：
1. Vercel自动配置HTTPS，通常不需要手动操作
2. 如果自定义域名，确保DNS配置正确
3. 等待SSL证书生成（通常需要几分钟到几小时）
4. 强制使用HTTPS

```typescript
// middleware.ts
export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};
```

---

### 6.3 数据泄露风险

**预防措施**：

**1. 环境变量安全**
- ✅ 不要将 `.env` 文件提交到Git
- ✅ 不要在代码中硬编码密码
- ✅ 定期轮换数据库密码

**2. API安全**
```typescript
// 添加认证中间件
export function authMiddleware(req: Request) {
  // 验证用户身份
  // 检查权限
}
```

**3. 数据库安全**
```sql
-- 启用Row Level Security
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 创建安全策略
CREATE POLICY user_own_orders
ON orders FOR ALL
USING (designer_id = current_user_id());
```

---

## 调试技巧

### 查看日志

**Vercel日志**：
1. 进入Vercel项目
2. 点击 **Logs** 标签
3. 选择实时日志或历史日志

**Supabase日志**：
1. 登录Supabase Dashboard
2. 点击 **Logs** 标签
3. 选择API Logs或Database Logs

**浏览器控制台**：
1. 按F12打开开发者工具
2. 查看Console标签
3. 查看Network标签的请求详情

---

## 获取帮助

如果以上解决方案无法解决你的问题：

1. **查看官方文档**：
   - Vercel: https://vercel.com/docs
   - Supabase: https://supabase.com/docs
   - Next.js: https://nextjs.org/docs

2. **搜索问题**：
   - Google/百度搜索具体错误信息
   - GitHub Issues搜索

3. **社区支持**：
   - Vercel Discord
   - Supabase Discord
   - Stack Overflow

---

## 快速故障排除流程

```mermaid
graph TD
    A[出现问题] --> B{问题类型}
    B -->|部署| C[检查Vercel日志]
    B -->|数据库| D[检查Supabase日志]
    B -->|功能| E[检查浏览器控制台]
    C --> F[根据日志定位问题]
    D --> F
    E --> F
    F --> G{找到解决方案?}
    G -->|是| H[实施解决方案]
    G -->|否| I[搜索文档或社区]
    I --> H
    H --> J[重新测试]
    J --> K{问题解决?}
    K -->|是| L[✅ 完成]
    K -->|否| M[重复流程]
```

---

**记住**：大多数问题都有解决方案，保持耐心，逐步排查！
