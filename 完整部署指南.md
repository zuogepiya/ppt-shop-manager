# 完整部署指南 - PPT Shop Manager 系统

## 📋 前置条件

- ✅ Supabase 账户
- ✅ Vercel 账户
- ✅ 代码已推送到 GitHub
- ✅ Supabase 项目密码：`Yaq199712@`
- ✅ Supabase 项目标识：`rffppmzvtysyojrznbgo`

---

## 第一步：配置 Supabase 数据库连接

### 1.1 登录 Supabase

1. 访问 https://supabase.com/dashboard
2. 登录你的账号
3. 点击你的项目

### 1.2 获取 Session Pooler 连接字符串

1. 在左侧菜单，点击 **"Settings"** → **"Database"**
2. 向下滚动到 **Connection String** 部分
3. 在 **Type** 下拉菜单中，选择 **"Connection pooling"**
4. 在 **Mode** 下拉菜单中，选择 **"Session"**
5. **复制**连接字符串

**你看到的连接字符串应该是：**
```
postgresql://postgres.rffppmzvtysyojrznbgo:[YOUR-PASSWORD]@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres
```

### 1.3 替换密码并编码

**关键步骤：**

你的密码是 `Yaq199712@`，包含 `@` 符号，需要编码为 `%40`

**完整的 DATABASE_URL（请复制这个）：**
```
postgresql://postgres.rffppmzvtysyojrznbgo:Yaq199712%40@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres
```

**说明：**
- `Yaq199712@` 中的 `@` 编码为 `%40`
- 其他部分保持不变

**验证格式：**
- 协议：`postgresql://` ✅
- 用户名：`postgres.rffppmzvtysyojrznbgo` ✅
- 密码：`Yaq199712%40` ✅（@ 已编码）
- 主机：`aws-0-ap-southeast-1.pooler.supabase.com` ✅
- 端口：`6543` ✅
- 数据库：`postgres` ✅

**请复制这个字符串保存到记事本，下一步要用：**
```
postgresql://postgres.rffppmzvtysyojrznbgo:Yaq199712%40@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres
```

---

## 第二步：配置 Vercel 环境变量

### 2.1 登录 Vercel

1. 访问 https://vercel.com/dashboard
2. 找到你的项目 `ppt-shop-manager`
3. 点击项目名称进入

### 2.2 配置环境变量

#### 环境变量 1：DATABASE_URL

1. 点击项目顶部的 **"Settings"** 标签
2. 点击左侧菜单 **"Environment Variables"**
3. 找到现有的 `DATABASE_URL`（如果有），点击编辑按钮
4. 或点击 **"Add New"** 添加新的环境变量
5. 填写以下内容：

```
Key: DATABASE_URL
Value: postgresql://postgres.rffppmzvtysyojrznbgo:Yaq199712%40@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres
Environments: ✅ Production
              ✅ Preview
              ✅ Development
```

6. 点击 **Save** 保存

**注意：**
- Value 部分请**完整复制粘贴**上面的连接字符串
- 不要有额外空格
- 确保 `@` 已编码为 `%40`

#### 环境变量 2：SESSION_SECRET

1. 点击 **"Add New"** 按钮
2. 填写以下内容：

```
Key: SESSION_SECRET
Value: ppt-shop-session-2025-secret-key-abc123xyz-secure-random-string
Note: 用于 Session 加密的密钥
Environments: ✅ Production
              ✅ Preview
              ✅ Development
```

3. 点击 **Add** 或 **Save**

**说明：**
- SESSION_SECRET 可以是任意字符串，建议使用复杂的随机字符串
- 如果你想生成新的密钥，可以在这里生成：https://www.random.org/strings/

#### 环境变量 3：NODE_ENV（可选，但推荐）

1. 点击 **"Add New"** 按钮
2. 填写以下内容：

```
Key: NODE_ENV
Value: production
Environments: ✅ Production
              ✅ Preview
              ✅ Development
```

3. 点击 **Add** 或 **Save**

### 2.3 验证环境变量配置

在 Vercel 的环境变量页面，你应该看到：

| Key | Value | Environments |
|-----|-------|--------------|
| DATABASE_URL | `postgresql://postgres.rffppmzvtysyojrznbgo:Yaq199712%40@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres` | ✅ Production, Preview, Development |
| SESSION_SECRET | `ppt-shop-session-2025-secret-key-abc123xyz-secure-random-string` | ✅ Production, Preview, Development |
| NODE_ENV | `production` | ✅ Production, Preview, Development |

**检查清单：**
- [ ] DATABASE_URL 使用 Session Pooler 连接
- [ ] DATABASE_URL 密码中的 @ 已编码为 %40
- [ ] SESSION_SECRET 已添加
- [ ] 所有环境变量都勾选了 Production, Preview, Development
- [ ] 所有变量都已保存

---

## 第三步：重新部署项目

### 3.1 找到部署页面

1. 在 Vercel 项目页面，点击顶部的 **"Deployments"** 标签
2. 找到最新的部署记录（标记为 "Current"）

### 3.2 触发重新部署

1. 点击最新部署记录右侧的 **"···"**（三个点）菜单
2. 选择 **"Redeploy"**
3. 在弹出的对话框中，确认信息无误
4. 点击 **"Redeploy"** 按钮

### 3.3 等待部署完成

部署需要 2-3 分钟，你会看到以下状态变化：

1. **Queued** - 排队中
2. **Building** - 构建中（约 1-2 分钟）
3. **Deploying** - 部署中（约 30 秒）
4. **Ready** - 部署成功 ✅

**监控部署：**
- 在部署页面，点击部署记录可以查看实时日志
- 确认没有错误信息

---

## 第四步：验证部署成功

### 4.1 检查部署状态

在 Vercel Deployments 页面，确认：

- 最新部署的状态显示 **Ready**（绿色）✅
- 没有错误信息 ✅

### 4.2 测试网站访问

在浏览器中访问以下网址：

#### 测试 1：主页

**网址：** https://ppt-shop-manager.vercel.app

**预期结果：**
- ✅ 页面正常加载
- ✅ 显示登录界面
- ✅ 界面样式正常

**如果失败：**
- 刷新页面重试
- 查看浏览器控制台错误（按 F12）

#### 测试 2：数据库初始化

**网址：** https://ppt-shop-manager.vercel.app/api/init-db

**预期结果：**
```json
{
  "success": true,
  "message": "数据库初始化成功"
}
```

**如果显示：**
```json
{
  "success": true,
  "message": "数据库表已存在"
}
```

这也表示成功 ✅（说明之前已经初始化过）

**如果失败：**
- 检查 DATABASE_URL 是否正确
- 确认 Supabase 数据库状态为 Active
- 查看浏览器控制台错误

#### 测试 3：登录功能

**网址：** https://ppt-shop-manager.vercel.app

**使用默认管理员账号登录：**
- 用户名：`admin`
- 密码：`admin123`

**预期结果：**
- ✅ 登录成功
- ✅ 跳转到总台管理页面
- ✅ 显示四个角色端口入口

**如果登录失败：**
- 检查 SESSION_SECRET 是否已配置
- 检查数据库是否已初始化（访问 /api/init-db）
- 查看浏览器控制台错误

---

## 第五步：测试各角色端口

### 5.1 总台管理端口

**网址：** https://ppt-shop-manager.vercel.app/dashboard/admin

**功能测试：**
- ✅ 员工管理页面
- ✅ 订单管理页面
- ✅ 财务管理页面

### 5.2 管理者端口

**网址：** https://ppt-shop-manager.vercel.app/dashboard/manager

**功能测试：**
- ✅ 查看员工列表
- ✅ 查看订单统计

### 5.3 客服端口

**网址：** https://ppt-shop-manager.vercel.app/dashboard/cs

**功能测试：**
- ✅ 客户管理
- ✅ 订单查询

### 5.4 设计师端口

**网址：** https://ppt-shop-manager.vercel.app/dashboard/designer

**功能测试：**
- ✅ 查看分配的任务
- ✅ 更新任务状态

---

## 常见问题排查

### 问题 1：部署显示 Ready 但访问 500 错误

**原因：** 环境变量未正确配置

**解决方法：**
1. 检查 DATABASE_URL 格式是否正确
2. 确认密码中的 @ 已编码为 %40
3. 确认使用 Session Pooler 连接（端口 6543）
4. 检查 SESSION_SECRET 是否已配置

### 问题 2：数据库连接失败

**原因：** Supabase 连接方式不正确

**解决方法：**
1. 确认使用 Connection Pooling → Session 模式
2. 确认主机地址是 `aws-0-ap-southeast-1.pooler.supabase.com`
3. 确认端口是 `6543`
4. 确认用户名是 `postgres.rffppmzvtysyojrznbgo`

### 问题 3：登录失败

**原因：** 数据库未初始化或 SESSION_SECRET 未配置

**解决方法：**
1. 访问 /api/init-db 初始化数据库
2. 检查 SESSION_SECRET 是否已配置
3. 确认默认账号密码是 admin/admin123

### 问题 4：页面样式混乱

**原因：** CSS 加载失败

**解决方法：**
1. 清除浏览器缓存
2. 硬刷新页面（Ctrl + Shift + R）
3. 检查浏览器控制台是否有资源加载错误

---

## 部署成功标志

当以下所有条件满足时，部署成功：

- [ ] Vercel 部署状态显示 Ready ✅
- [ ] 主页可以正常访问 ✅
- [ ] /api/init-db 返回成功 ✅
- [ ] 可以使用 admin/admin123 登录 ✅
- [ ] 四个角色端口都可以访问 ✅
- [ ] 员工管理、订单管理、财务管理功能正常 ✅

---

## 部署完成后的操作

### 1. 修改默认管理员密码

登录系统后，建议立即修改默认密码：

1. 以 admin 身份登录
2. 进入员工管理
3. 找到 admin 账号
4. 修改密码

### 2. 添加员工账号

1. 以 admin 身份登录
2. 进入员工管理
3. 添加新员工
4. 分配角色（总台管理、管理者、客服、设计师）

### 3. 分享访问地址

部署成功后，将网址分享给员工：

**主网址：** https://ppt-shop-manager.vercel.app

员工使用分配的账号和密码登录即可访问各自的管理端口。

---

## 技术支持

如果在部署过程中遇到问题，请提供以下信息：

1. 部署状态（Ready / Building / Error）
2. 错误信息（从部署日志或浏览器控制台复制）
3. 浏览器访问时的错误描述
4. 环境变量配置（隐藏密码部分）

---

**祝部署成功！🎉**
